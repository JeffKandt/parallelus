#!/usr/bin/env bash
set -euo pipefail

# Portable audible/log alert helper.
# Usage: agents-alert "Message here" (message optional; falls back to env or default).

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../agentrc
. "${SCRIPT_DIR}/../agentrc"

MSG="${1:-${AUDIBLE_ALERT_MESSAGE:-${ALERT_DEFAULT_MESSAGE:-Agent pause}}}"
force_audio="${AUDIBLE_ALERT_FORCE_AUDIO:-}"
require_tty="${AUDIBLE_ALERT_REQUIRE_TTY:-0}"
subagent_flag="${SUBAGENT:-}"
ci_flag="${CI:-}"

is_true() {
  case "$1" in
    1|true|TRUE|yes|YES|on|ON) return 0 ;;
    *) return 1 ;;
  esac
}

if is_true "$subagent_flag" || [[ "$ci_flag" == "true" ]]; then
  if [[ "$force_audio" != "1" ]]; then
    printf '[alert] %s\n' "$MSG"
    exit 0
  fi
fi

if [[ ! -t 1 ]]; then
  if [[ "$force_audio" == "1" || "$require_tty" != "1" ]]; then
    :
  else
    printf '[alert] %s\n' "$MSG"
    exit 0
  fi
fi

if command -v say >/dev/null 2>&1; then
  say -v "${AUDIBLE_ALERT_VOICE:-Alex}" "$MSG" || true
fi

if command -v afplay >/dev/null 2>&1; then
  if [[ -f /System/Library/Sounds/Glass.aiff ]]; then
    afplay /System/Library/Sounds/Glass.aiff >/dev/null 2>&1 || printf '\a'
  else
    printf '\a'
  fi
  printf '[alert] %s\n' "$MSG"
  exit 0
fi

if command -v paplay >/dev/null 2>&1; then
  paplay /usr/share/sounds/freedesktop/stereo/bell.oga >/dev/null 2>&1 || printf '\a'
  printf '[alert] %s\n' "$MSG"
  exit 0
fi

printf '\a'
printf '[alert] %s\n' "$MSG"
