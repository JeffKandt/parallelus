#!/usr/bin/env python3
import json
import os
import subprocess
from pathlib import Path

from parallelus_docs_paths import marker_read_path, reports_write_dir, self_improvement_read_roots

ALLOWED_SKIP_VAR = "AGENTS_RETRO_SKIP_VALIDATE"
NEW_AGENT_RC_FLAG = "AGENTS_REQUIRE_RETRO"
LEGACY_AGENT_RC_FLAG = "REQUIRE_AGENT_CI_AUDITS"


def git_root() -> Path:
    out = subprocess.check_output(["git", "rev-parse", "--show-toplevel"], text=True)
    return Path(out.strip())


def current_branch() -> str:
    out = subprocess.check_output(["git", "rev-parse", "--abbrev-ref", "HEAD"], text=True)
    branch = out.strip()
    if branch in {"HEAD", ""}:
        raise SystemExit("verify-retrospective: detached HEAD not supported")
    return branch


def load_agentrc(repo: Path) -> dict:
    agentrc = repo / "parallelus/engine" / "agentrc"
    data = {}
    if agentrc.exists():
        for line in agentrc.read_text().splitlines():
            line = line.strip()
            if not line or line.startswith("#"):
                continue
            if "=" in line:
                key, value = line.split("=", 1)
                data[key.strip()] = value.strip().strip('"')
    return data


def main() -> None:
    repo = git_root()
    branch = current_branch()
    slugged = branch.replace("/", "-")

    agentrc = load_agentrc(repo)
    require_retro = agentrc.get(NEW_AGENT_RC_FLAG)
    if require_retro is None:
        require_retro = agentrc.get(LEGACY_AGENT_RC_FLAG, "1")
    role_prompt = agentrc.get("AGENT_CI_AGENT_ROLE", "continuous_improvement_auditor")
    if require_retro.lower() in {"0", "false", "no"}:
        return

    if os.environ.get(ALLOWED_SKIP_VAR):
        return

    report_dirs = [root / "reports" for root in self_improvement_read_roots(repo)]
    marker_path = marker_read_path(repo, slugged)

    if not marker_path.exists():
        pattern = f"{slugged}--*.json"
        any_reports = False
        for reports_dir in report_dirs:
            if reports_dir.exists() and any(reports_dir.glob(pattern)):
                any_reports = True
                break
        if not any_reports:
            return  # nothing to validate yet
        raise SystemExit(
            "verify-retrospective: marker not found but reports exist; please run the "
            f"{role_prompt} prompt before turn_end."
        )

    try:
        marker = json.loads(marker_path.read_text())
    except Exception as exc:
        raise SystemExit(f"verify-retrospective: unable to parse {marker_path}: {exc}")

    marker_ts = marker.get("timestamp")
    if not marker_ts:
        raise SystemExit(f"verify-retrospective: marker {marker_path} missing timestamp")

    if not any(path.exists() for path in report_dirs):
        raise SystemExit(
            "verify-retrospective: no reports directory; run the "
            f"{role_prompt} prompt before make turn_end."
        )

    expected = f"{slugged}--{marker_ts}.json"
    target = None
    for reports_dir in report_dirs:
        candidate = reports_dir / expected
        if candidate.exists():
            target = candidate
            break
    if target is None:
        target = reports_write_dir(repo) / expected
    if not target.exists():
        raise SystemExit(
            "verify-retrospective: latest marker has no matching retrospective report. "
            f"Run the {role_prompt} prompt before calling make turn_end again."
        )

    try:
        data = json.loads(target.read_text())
    except Exception as exc:
        raise SystemExit(f"verify-retrospective: unable to parse {target}: {exc}")

    if data.get("branch") != branch or data.get("marker_timestamp") != marker_ts:
        raise SystemExit(
            "verify-retrospective: report contents do not match current branch/marker; rerun the "
            f"{role_prompt} prompt."
        )

    print(
        f"verify-retrospective: found report {target.relative_to(repo)}",
        flush=True,
    )


if __name__ == "__main__":
    main()
